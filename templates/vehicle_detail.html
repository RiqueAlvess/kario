{% extends 'base.html' %}

{% block title %}{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }} - Kario Garage{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4>Detalhes do Ve√≠culo</h4>
    {% if is_staff %}
    <div>
        <a href="{% url 'vehicle_edit' vehicle.id %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil"></i> Editar
        </a>
    </div>
    {% endif %}
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</h5>
        {% if vehicle.trim %}
        <p class="text-muted">{{ vehicle.trim }}</p>
        {% endif %}
        
        <div class="mb-3">
            {% if vehicle.status == 'DISPONIVEL' %}
                <span class="badge bg-success">Dispon√≠vel</span>
            {% elif vehicle.status == 'VENDIDO' %}
                <span class="badge bg-danger">Vendido</span>
            {% elif vehicle.status == 'MECANICA' %}
                <span class="badge bg-warning text-dark">Mec√¢nica</span>
            {% else %}
                <span class="badge bg-info text-dark">Falta Inspe√ß√£o</span>
            {% endif %}
            
            {% if vehicle.title_status == 'LIMPO' %}
                <span class="badge bg-primary">T√≠tulo Limpo</span>
            {% else %}
                <span class="badge bg-secondary">{{ vehicle.title_status }}</span>
            {% endif %}
        </div>
        
        {% if vehicle.status != 'DISPONIVEL' and vehicle.status != 'VENDIDO' %}
        <div class="alert alert-warning">
            <strong>Progresso da Ficha T√©cnica: {{ vehicle.inspection_progress }}%</strong>
            <div class="progress mt-2" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated {% if vehicle.inspection_progress == 100 %}bg-success{% endif %}" role="progressbar" 
                     style="width: {{ vehicle.inspection_progress }}%;" 
                     aria-valuenow="{{ vehicle.inspection_progress }}" aria-valuemin="0" aria-valuemax="100">
                    {{ vehicle.inspection_progress }}%
                </div>
            </div>
            <small class="d-block mt-2">Complete a ficha t√©cnica para tornar o ve√≠culo dispon√≠vel</small>
        </div>
        {% endif %}

        {% if vehicle.general_notes %}
        <div class="alert alert-light border">
            <strong><i class="bi bi-chat-left-text"></i> Observa√ß√µes Gerais:</strong><br>
            <p class="mb-0 mt-2">{{ vehicle.general_notes }}</p>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-6">
                <p class="mb-2"><strong>VIN:</strong><br>{{ vehicle.vin|default:"N/A" }}</p>
                <p class="mb-2"><strong>Motor:</strong><br>{{ vehicle.engine|default:"N/A" }}</p>
                <p class="mb-2"><strong>Transmiss√£o:</strong><br>{{ vehicle.transmission|default:"N/A" }}</p>
                <p class="mb-2"><strong>Tra√ß√£o:</strong><br>{{ vehicle.train|default:"N/A" }}</p>
            </div>
            <div class="col-6">
                <p class="mb-2"><strong>Cor Externa:</strong><br>{{ vehicle.exterior_color }}</p>
                <p class="mb-2"><strong>Cor Interna:</strong><br>{{ vehicle.interior_color }}</p>
                <p class="mb-2"><strong>Milhas:</strong><br>{{ vehicle.miles|floatformat:0 }}</p>
                <p class="mb-2"><strong>MPG:</strong><br>{{ vehicle.mpg|default:"N/A" }}</p>
            </div>
        </div>

        <p class="mb-2"><strong>Valor:</strong> ${{ vehicle.value|floatformat:2 }}</p>

        {% if vehicle.title_status != 'LIMPO' and vehicle.title_problem_description %}
        <div class="alert alert-warning mt-3">
            <strong>Problema no T√≠tulo:</strong><br>
            {{ vehicle.title_problem_description }}
        </div>
        {% endif %}

        {% if vehicle.updated_by %}
        <p class="text-muted small mb-0"><i class="bi bi-person-circle"></i> √öltima atualiza√ß√£o por: {{ vehicle.updated_by.username }} em {{ vehicle.updated_at|date:"d/m/Y H:i" }}</p>
        {% endif %}
    </div>
</div>

<!-- Financing Calculator for Utah -->
<div class="card mb-3">
    <div class="card-header bg-success text-white">
        <strong><i class="bi bi-calculator"></i> Estimativa de Financiamento (Utah, EUA)</strong>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-6">
                <p class="mb-2"><strong>Valor do Ve√≠culo:</strong><br>${{ financing.vehicle_value|floatformat:2 }}</p>
                <p class="mb-2"><strong>Entrada (20%):</strong><br><span class="text-success">${{ financing.down_payment|floatformat:2 }}</span></p>
                <p class="mb-2"><strong>Valor Financiado:</strong><br>${{ financing.loan_amount|floatformat:2 }}</p>
            </div>
            <div class="col-6">
                <p class="mb-2"><strong>Taxa APR:</strong><br>{{ financing.apr }}%</p>
                <p class="mb-2"><strong>Prazo:</strong><br>{{ financing.term_months }} meses</p>
                <p class="mb-2"><strong>Parcela Mensal:</strong><br><span class="text-primary fw-bold fs-5">${{ financing.monthly_payment|floatformat:2 }}</span></p>
            </div>
        </div>
        <hr>
        <p class="mb-1 small text-muted"><strong>Total de Juros:</strong> ${{ financing.total_interest|floatformat:2 }}</p>
        <p class="mb-0 small text-muted"><strong>Custo Total:</strong> ${{ financing.total_cost|floatformat:2 }}</p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Fotos do Ve√≠culo ({{ photos.count }})</strong>
        {% if is_staff %}
        <a href="{% url 'photo_upload' vehicle.id %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-camera"></i> Adicionar
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        {% if photos %}
        <div class="row g-2">
            {% for photo in photos %}
            <div class="col-6 col-md-4">
                <div class="position-relative photo-item">
                    <img src="{{ photo.image_url }}" class="img-fluid rounded clickable-photo" alt="Foto do ve√≠culo"
                         style="width: 100%; height: 150px; object-fit: cover; cursor: pointer;"
                         onclick="openPhotoCarousel({{ forloop.counter0 }})">
                    {% if is_staff %}
                    <form method="POST" action="{% url 'photo_delete' photo.id %}" class="position-absolute top-0 end-0 m-2">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Remover esta foto?')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                    {% endif %}
                    {% if photo.description %}
                    <small class="d-block text-muted mt-1">{{ photo.description }}</small>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-muted text-center mb-0">Nenhuma foto adicionada</p>
        {% endif %}
    </div>
</div>

<!-- Photo Carousel Modal -->
<div class="modal fade" id="photoCarouselModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">Fotos do Ve√≠culo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div id="photoCarousel" class="carousel slide" data-bs-ride="false">
                    <div class="carousel-inner">
                        {% for photo in photos %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            <img src="{{ photo.image_url }}" class="d-block w-100" alt="Foto {{ forloop.counter }}" style="max-height: 70vh; object-fit: contain;">
                            {% if photo.description %}
                            <div class="carousel-caption">
                                <p class="bg-dark bg-opacity-75 rounded px-3 py-2">{{ photo.description }}</p>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% if photos.count > 1 %}
                    <button class="carousel-control-prev" type="button" data-bs-target="#photoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Anterior</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#photoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Pr√≥xima</span>
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-success btn-sm" onclick="downloadCurrentPhoto()">
                    <i class="bi bi-download"></i> Baixar Imagem
                </button>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
        <strong>Ficha T√©cnica de Inspe√ß√£o</strong>
        {% if is_staff %}
        <a href="{% url 'inspection_update' vehicle.id %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil"></i> Editar
        </a>
        {% endif %}
    </div>
    <div class="card-body">
        <div class="list-group list-group-flush">
            {% for inspection in inspections %}
            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                <span style="font-size: 14px;">{{ inspection.template.item_name }}</span>
                {% if inspection.status == 'SIM' %}
                    <span class="badge bg-success">Sim</span>
                {% elif inspection.status == 'NAO' %}
                    <span class="badge bg-danger">N√£o</span>
                {% else %}
                    <span class="badge bg-secondary">N/R</span>
                {% endif %}
            </div>
            {% if inspection.observation %}
            <small class="text-muted d-block mb-2 px-0">üí¨ {{ inspection.observation }}</small>
            {% endif %}
            {% endfor %}
        </div>
    </div>
</div>

{% if vehicle.status == 'DISPONIVEL' and is_staff %}
<div class="d-grid gap-2">
    <a href="{% url 'vehicle_sell' vehicle.id %}" class="btn btn-success">
        <i class="bi bi-cash"></i> Vender Ve√≠culo
    </a>
</div>
{% endif %}

{% endblock %}

{% block extra_css %}
<style>
    .clickable-photo {
        transition: transform 0.2s, opacity 0.2s;
    }
    .clickable-photo:hover {
        transform: scale(1.05);
        opacity: 0.9;
    }
    .photo-item {
        overflow: hidden;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const photoUrls = [
        {% for photo in photos %}
        "{{ photo.image_url }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    function openPhotoCarousel(index) {
        const modal = new bootstrap.Modal(document.getElementById('photoCarouselModal'));
        const carousel = new bootstrap.Carousel(document.getElementById('photoCarousel'));
        carousel.to(index);
        modal.show();
    }

    function downloadCurrentPhoto() {
        const carousel = document.getElementById('photoCarousel');
        const activeItem = carousel.querySelector('.carousel-item.active');
        const img = activeItem.querySelector('img');
        const imageUrl = img.src;

        // Create a temporary link and trigger download
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = 'vehicle_photo_' + new Date().getTime() + '.jpg';
        link.target = '_blank';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Lazy loading for images
    document.addEventListener('DOMContentLoaded', function() {
        const images = document.querySelectorAll('.clickable-photo');
        if ('loading' in HTMLImageElement.prototype) {
            images.forEach(img => {
                img.loading = 'lazy';
            });
        }
    });
</script>
{% endblock %}